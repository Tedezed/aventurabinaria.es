<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Aventura Binaria</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/css/theme_v2.css" rel="stylesheet" type="text/css">
    <link href="/css/syntax.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" type="image/png" href="https://www.aventurabinaria.es/images/favicon-32x32.png"/>


</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Aventura Binaria</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <!--<li class="active"><a href="/">Home</a></li>-->
                    <li class="active visible-xs-block"><a href="/links.html">Links</a></li>
                    <li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
                    <!--<li class="active"><a href="/about.html">About</a></li>-->
                    <!--<li class="active"><a href="/space.html">Space</a></li>-->
                    
                    
                      <li class="nav-item"><a class="nav-link" href="https://github.com/Tedezed">Github</a></li>
                    
                    <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS</a></li>
                </ul>
              </div>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
Blog Sysadmin/DevOps on Github - GNU/Linux
</div>

<div class="sidebar well">
<h4>Links</h4>
<ul>
  <li><a href="http://tedezed.github.io/Celtic-Kubernetes/HTML">Celtic Kubernetes</a></li>
  <li><a href="https://twitter.com/zerrotajo">Twitter</a></li>
  <li><a href="https://www.thingiverse.com/tedezed/designs">Thingiverse</a></li>
  <li><a href="mailto:juanmanuel.torres@aventurabinaria.es">Mail</a></li>
</ul>

</div>

<div class="sidebar well">
    <h4>Recent Posts</h4>
    <ul>
        
          <li><a href="/2020/12/Install-amd-drivers-linux-debian-ubuntu">Install AMD drivers for Linux (Debian/Ubuntu)</a></li>
        
          <li><a href="/2020/04/Change-local-port-in-Sendmail">Change local port in Sendmail</a></li>
        
          <li><a href="/2019/10/Examples-Nanorc">Examples Nanorc</a></li>
        
          <li><a href="/2019/07/Massive-editor-json-for-Kubernetes">Massive editor json for Kubernetes</a></li>
        
          <li><a href="/2019/03/Ingress-TCP-UDP">Ingress TCP/UDP</a></li>
        
          <li><a href="/2019/03/Delete-namespace-in-perpetual-Terminating-state">Delete namespace in perpetual Terminating state</a></li>
        
          <li><a href="/2017/06/External-Load-Balancer-for-Kubernetes-HAProxy">External Load Balancer for Kubernetes - HAProxy</a></li>
        
          <li><a href="/2017/05/Galera-Cluster-on-Debian-8">Galera Cluster on Debian 8</a></li>
        
          <li><a href="/2017/02/Creaci%C3%B3n-publicacion-y-firma-de-claves-PGP">Creación, publicación y firma de claves PGP</a></li>
        
          <li><a href="/2016/08/Poblar-LDAP-desde-fichero-JSON-PAM-y-SSH-con-Clave-publica">Poblar LDAP desde fichero JSON [PAM y SSH con Clave publica]</a></li>
        
          <li><a href="/2016/08/Pantalla-LCD-16-2-y-PCF8574-(I2C)-para-Arduino">Pantalla LCD 16×2 y PCF8574 (I2C) para Arduino</a></li>
        
          <li><a href="/2016/08/Pantalla-LCD-16x2-y-PCF8574-(I2C)-para-Raspberry-pi">Pantalla LCD 16x2 y PCF8574 (I2C) para Raspberry pi</a></li>
        
    </ul>
</div>

        </div>
        <div class="col-md-6">
          <div class="article">
            <div class="well">
                <h1><a href="/2016/05/Conexi%C3%B3n-VPN-cliente-a-red-con-OpenVPN-y-certificados-x509">Conexión VPN cliente a red con OpenVPN y certificados x509</a></h1>
                <h5>6 May, 2016</h5>
                <hr/>
            
                
                <p class="author"><a href="#disqus_thread" data-disqus-identifier="2016-05-conexi-c3-b3n-vpn-cliente-a-red-con-openvpn-y-certificados-x509">Comments</a></p>
                
            
            <div class="post-content">
            <p>En esta entrada explicare como realizar una configuración cliente VPN a red privada (VPN host to net) con un túnel VPN con certificados x509.</p>

<p>En primer lugar instalamos openvpn y openssl para el certificado:</p>
<pre>apt-get install openvpn openssl</pre>
<p>Bajamos los script de ejemplo o lo instalamos desde repositorios:
Opción 1:</p>
<pre>apt-get install easy-rsa</pre>
<p>Opción 2:</p>
<pre>git clone https://github.com/OpenVPN/easy-rsa.git -b 'release/2.x'</pre>
<p>Copiamos los script de ejemplo:</p>
<pre>cd /etc/openvpn/
mkdir easy-rsa
cp -r /root/easy-rsa/easy-rsa/2.0/* easy-rsa</pre>
<p>Dentro de /etc/openvpn/easy-rsa/vars podremos configurar algunas variables de entorno que cargaremos posteriormente, vamos a modificar:</p>
<pre>export KEY_SIZE=2048
export CA_EXPIRE=3650
export KEY_EXPIRE=3650
export KEY_COUNTRY="ES"
export KEY_PROVINCE="Sevilla"
export KEY_CITY="Dos Hermanas"
export KEY_ORG="IESGN"
export KEY_EMAIL="juanmanuel.torres@aventurabinaria.es"
export KEY_OU="Informatica"

export KEY_NAME="vpn_key"
# PKCS11 Smart Card
export PKCS11_MODULE_PATH="/usr/lib/changeme.so"
export PKCS11_PIN=1234
export KEY_CN="ServidorVPN"
</pre>
<p>Cargamos las variables de entorno anteriores:</p>
<pre>root@servidorvpn:/etc/openvpn/easy-rsa# source vars
NOTE: If you run ./clean-all, I will be doing a rm -rf on /etc/openvpn/easy-rsa/keys
</pre>
<p><strong>Creación del certificado:</strong></p>

<p>Borramos las claves anteriores:</p>
<pre>root@servidorvpn:/etc/openvpn/easy-rsa# ./clean-all</pre>
<p>Creamos dh:</p>
<pre>root@servidorvpn:/etc/openvpn/easy-rsa# ./build-dh
Generating DH parameters, 2048 bit long safe prime, generator 2
.............
root@servidorvpn:/etc/openvpn/easy-rsa# ./build-ca
Generating a 2048 bit RSA private key
.............
Country Name (2 letter code) [ES]:
State or Province Name (full name) [Sevilla]:
Locality Name (eg, city) [Dos Hermanas]:
Organization Name (eg, company) [IESGN]:
Organizational Unit Name (eg, section) [Informatica]:
Common Name (eg, your name or your server's hostname) [ServidorVPN]:
Name [vpn_key]:
Email Address [juanmanuel.torres@aventurabinaria.es]:
</pre>
<p>Creación del certificado para el servidor:</p>
<pre>root@servidorvpn:/etc/openvpn/easy-rsa# ./build-key-server ServidorVPN
Generating a 2048 bit RSA private key
........+++
.............................................+++
writing new private key to 'ServidorVPN.key'
----
Country Name (2 letter code) [ES]:
State or Province Name (full name) [Sevilla]:
Locality Name (eg, city) [Dos Hermanas]:
Organization Name (eg, company) [IESGN]:
Organizational Unit Name (eg, section) [Informatica]:
Common Name (eg, your name or your server's hostname) [ServidorVPN]:
Name [vpn_key]:
Email Address [juanmanuel.torres@aventurabinaria.es]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:<strong>tu_contraseña</strong>
An optional company name []:
</pre>
<p>Creamos el certificado para el cliente:</p>
<pre>root@servidorvpn:/etc/openvpn/easy-rsa# ./build-key cliente-vpn
Generating a 2048 bit RSA private key
...............+++
...................................................+++
writing new private key to 'cliente-vpn.key'
-----
Country Name (2 letter code) [ES]:
State or Province Name (full name) [Sevilla]:
Locality Name (eg, city) [Dos Hermanas]:
Organization Name (eg, company) [IESGN]:
Organizational Unit Name (eg, section) [Informatica]:
Common Name (eg, your name or your server's hostname) [cliente-vpn]:
Name [vpn_key]:
Email Address [juanmanuel.torres@aventurabinaria.es]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</pre>
<p>Las claves se encuentran en la carpeta: /etc/openvpn/easy-rsa/keys/</p>

<p><strong>Configuración del servidor VPN:</strong></p>

<p>Copiamos el paquete de ejemplo de configuración del servidor:</p>
<pre>gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz &gt; /etc/openvpn/server.conf</pre>
<p>Configuración del servidor:</p>
<pre>nano server.conf</pre>
<pre>port 1194
proto udp
dev tun
ca /etc/openvpn/easy-rsa/keys/ca.crt
cert /etc/openvpn/easy-rsa/keys/ServidorVPN.crt
key /etc/openvpn/easy-rsa/keys/ServidorVPN.key
dh /etc/openvpn/easy-rsa/keys/dh2048.pem
server 10.88.88.0 255.255.255.0
push "route 10.99.99.0 255.255.255.0"
ifconfig-pool-persist ipp.txt
keepalive 10 120
comp-lzo
persist-key
persist-tun
status openvpn-status.log
log /var/log/openvpn.log
verb 4
</pre>
<p>Activamos el encaminamiento:</p>
<pre>nano /etc/sysctl.conf</pre>
<pre>net.ipv4.ip_forward=1</pre>
<pre>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</pre>
<p>Reiniciamos el servicio:</p>
<pre>service openvpn restart
service openvpn status</pre>
<p><strong>Configuración del cliente en el servidor:</strong></p>
<pre>cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/easy-rsa/keys/client.ovpn</pre>
<p>Modificamos:</p>
<pre>nano /etc/openvpn/easy-rsa/keys/client.ovpn</pre>
<pre>remote 10.0.0.33 1194</pre>
<p>Tranferimos los certificados al cliente,en mi caso para realizar la prueba lo pasare a otra maquina por scp:</p>
<pre>scp /etc/openvpn/easy-rsa/keys/cliente-vpn.key debian@172.33.23.92:/home/debian/openvpn
scp /etc/openvpn/easy-rsa/keys/cliente-vpn.crt debian@172.33.23.92:/home/debian/openvpn
scp /etc/openvpn/easy-rsa/keys/ca.crt debian@172.33.23.92:/home/debian/openvpn
scp /etc/openvpn/easy-rsa/keys/client.ovpn debian@172.33.23.92:/home/debian/openvpn
</pre>
<p><strong>Configuración del cliente:</strong></p>

<p>Movemos los certificados y la configuración:</p>
<pre>sudo mv /home/debian/openvpn/* /etc/openvpn/
sudo mv client.ovpn client.conf
</pre>
<p>Editamos la configuración del cliente:</p>
<pre>nano /etc/openvpn/client.conf</pre>
<pre>client
dev tun
proto udp
remote 10.0.0.33 1194
keepalive 10 120
resolv-retry infinite
nobind
persist-key
persist-tun
ca /etc/openvpn/ca.crt
cert /etc/openvpn/cliente-vpn.crt
key /etc/openvpn/cliente-vpn.key
#ns-cert-type server
comp-lzo
verb 4
log /var/log/openvpn.log
</pre>
<p>Quitamos el arranque automatico de OpenVPN:</p>
<pre>update-rc.d -f openvpn remove
</pre>
<p>Reiniciamos el servicio:</p>
<pre>service openvpn restart</pre>
<p>Comprobamos el funcionamiento del tunel:</p>
<pre>root@<strong>servidorvpn</strong>:/etc/openvpn# ifconfig tun0
tun0 Link encap:UNSPEC HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
inet addr:10.99.99.1 P-t-P:10.99.99.2 Mask:255.255.255.255
UP POINTOPOINT RUNNING NOARP MULTICAST MTU:1500 Metric:1
RX packets:8 errors:0 dropped:0 overruns:0 frame:0
TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
collisions:0 txqueuelen:100
RX bytes:672 (672.0 B) TX bytes:0 (0.0 B)

root@<strong>clientevpn</strong>:/etc/openvpn# ifconfig tun0
tun0 Link encap:UNSPEC HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
inet addr:10.99.99.6 P-t-P:10.99.99.5 Mask:255.255.255.255
UP POINTOPOINT RUNNING NOARP MULTICAST MTU:1500 Metric:1
RX packets:0 errors:0 dropped:0 overruns:0 frame:0
TX packets:6 errors:0 dropped:0 overruns:0 carrier:0
collisions:0 txqueuelen:100
RX bytes:0 (0.0 B) TX bytes:504 (504.0 B)
</pre>
<p>Añadimos una regla nat al servidor VPN:</p>
<pre>iptables -A POSTROUTING -t nat -s 10.88.88.0/24 -o eth0 -j MASQUERADE
</pre>
<p>Nos conectamos a la maquina de la red interna:</p>
<pre>ssh debian@10.99.99.3</pre>
<p>Con esto ya tendríamos funcionando nuestra conexión host to network con OpenVPN.</p>

            </div>
            
                
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
                
            
            </div>
          </div>
          <div class="pagination">
              
                <a class="btn btn-default" href="/2016/05/Compilar-Kernel-Linux" class="next">Newer Post</a>
              
              
                <a class="btn btn-default" href="/2016/05/Escalado-HDMI-con-xrandr" class="previous">Older Post</a>
              
          </div>
        </div>
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
    <!--<h4>Twitter</h4>
    <a class="twitter-timeline" data-height="515" href="https://twitter.com/Zerrotajo?ref_src=twsrc%5Etfw">Tweets by Zerrotajo</a>
    <a href="https://twitter.com/intent/tweet?button_hashtag=sysadmin&ref_src=twsrc%5Etfw" class="twitter-hashtag-button" data-show-count="false">#sysadmin</a>
    <a href="https://twitter.com/intent/tweet?button_hashtag=kubernetes&ref_src=twsrc%5Etfw" class="twitter-hashtag-button" data-show-count="false">#kubernetes</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>-->
<h4>Kubernetes Containers Tools</h4>
  <ul>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/squirrel">Squirel secrets rotation</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/liberty">Liberty Ingress</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/secure_emailing">Secure Emailing Gateway</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/cloud-cementery/docker">Cloud Cementery</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/cron-backup-kubernetes">Backups for Kubernetes in yaml</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/backup-db-cron">Backups/Snapshots for all</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/sftp-multiuser">SFTP Multiuser</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/statefulset_autoscaler">StatefulSet autoscaler</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/tools/Kubernetes/concurrent-kubectl-gcloud">Concurrent kubectl gcloud</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/debian-box">Debian Box</a></li>
  </ul>
</div>


        </div>
    </div>
</div>


  <script type="text/javascript">
    var disqus_shortname = 'www-aventurabinaria-es';

    var disqus_config = function () {
        this.page.identifier = '2016-05-conexi-c3-b3n-vpn-cliente-a-red-con-openvpn-y-certificados-x509';
    };

   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


<!--<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">&copy;2022 Aventura Binaria. Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a>
            under
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a></p>
        </div>
    </div>
</div>-->


  <script type="text/javascript">
    var disqus_shortname = 'www-aventurabinaria-es';

    var disqus_config = function () {
        this.page.identifier = '2016-05-conexi-c3-b3n-vpn-cliente-a-red-con-openvpn-y-certificados-x509';
    };

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>


<!--
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-153422845-1"></script>
  <script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-153422845-1');
  </script>

-->

</body>
</html>

