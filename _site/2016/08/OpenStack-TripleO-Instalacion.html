<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Aventura Binaria</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/css/theme_v2.css" rel="stylesheet" type="text/css">
    <link href="/css/syntax.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" type="image/png" href="https://www.aventurabinaria.es/images/favicon-32x32.png"/>


</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Aventura Binaria</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <!--<li class="active"><a href="/">Home</a></li>-->
                    <li class="active visible-xs-block"><a href="/links.html">Links</a></li>
                    <li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
                    <!--<li class="active"><a href="/about.html">About</a></li>-->
                    <!--<li class="active"><a href="/space.html">Space</a></li>-->
                    
                    
                      <li class="nav-item"><a class="nav-link" href="https://github.com/Tedezed">Github</a></li>
                    
                    <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS</a></li>
                </ul>
              </div>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
Blog Sysadmin/DevOps on Github - GNU/Linux
</div>

<div class="sidebar well">
<h4>Links</h4>
<ul>
  <li><a href="http://tedezed.github.io/Celtic-Kubernetes/HTML">Celtic Kubernetes</a></li>
  <li><a href="https://twitter.com/zerrotajo">Twitter</a></li>
  <li><a href="https://www.thingiverse.com/tedezed/designs">Thingiverse</a></li>
  <li><a href="mailto:juanmanuel.torres@aventurabinaria.es">Mail</a></li>
</ul>

</div>

<div class="sidebar well">
    <h4>Recent Posts</h4>
    <ul>
        
          <li><a href="/2020/12/Install-amd-drivers-linux-debian-ubuntu">Install AMD drivers for Linux (Debian/Ubuntu)</a></li>
        
          <li><a href="/2020/04/Change-local-port-in-Sendmail">Change local port in Sendmail</a></li>
        
          <li><a href="/2019/10/Examples-Nanorc">Examples Nanorc</a></li>
        
          <li><a href="/2019/07/Massive-editor-json-for-Kubernetes">Massive editor json for Kubernetes</a></li>
        
          <li><a href="/2019/03/Ingress-TCP-UDP">Ingress TCP/UDP</a></li>
        
          <li><a href="/2019/03/Delete-namespace-in-perpetual-Terminating-state">Delete namespace in perpetual Terminating state</a></li>
        
          <li><a href="/2017/06/External-Load-Balancer-for-Kubernetes-HAProxy">External Load Balancer for Kubernetes - HAProxy</a></li>
        
          <li><a href="/2017/05/Galera-Cluster-on-Debian-8">Galera Cluster on Debian 8</a></li>
        
          <li><a href="/2017/02/Creaci%C3%B3n-publicacion-y-firma-de-claves-PGP">Creación, publicación y firma de claves PGP</a></li>
        
          <li><a href="/2016/08/Poblar-LDAP-desde-fichero-JSON-PAM-y-SSH-con-Clave-publica">Poblar LDAP desde fichero JSON [PAM y SSH con Clave publica]</a></li>
        
          <li><a href="/2016/08/Pantalla-LCD-16-2-y-PCF8574-(I2C)-para-Arduino">Pantalla LCD 16×2 y PCF8574 (I2C) para Arduino</a></li>
        
          <li><a href="/2016/08/Pantalla-LCD-16x2-y-PCF8574-(I2C)-para-Raspberry-pi">Pantalla LCD 16x2 y PCF8574 (I2C) para Raspberry pi</a></li>
        
    </ul>
</div>

        </div>
        <div class="col-md-6">
          <div class="article">
            <div class="well">
                <h1><a href="/2016/08/OpenStack-TripleO-Instalacion">OpenStack TripleO [Instalación]</a></h1>
                <h5>2 Aug, 2016</h5>
                <hr/>
            
                
                <p class="author"><a href="#disqus_thread" data-disqus-identifier="2016-08-openstack-tripleo-instalacion">Comments</a></p>
                
            
            <div class="post-content">
            <p><strong>Laptop Overcloud</strong></p>

<p>Creamos el siguiente usuario:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>useradd -d /home/stack -m -s /bin/bash stack
passwd stack
</code></pre></div></div>

<p>Configuración de sudo:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano /etc/sudoers
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stack ALL=(root) NOPASSWD:ALL
centos ALL=(root) NOPASSWD:ALL
</code></pre></div></div>

<p>Entramos como stack:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su - stack
</code></pre></div></div>

<p>Actualizamos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum update
</code></pre></div></div>

<p>Cambiamos el nombre de la maquina:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo hostnamectl set-hostname undercloud.example.com
sudo hostnamectl set-hostname --transient undercloud.example.com
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /etc/hosts
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1         undercloud.example.com
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl restart network
</code></pre></div></div>

<p>Comprobamos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[stack@localhost ~]$ hostname
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undercloud.example.com
</code></pre></div></div>

<p>Repositorios necesarios:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum -y install epel-release
</code></pre></div></div>

<p>Instalamos yum-plugin-priorities:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum -y install yum-plugin-priorities
</code></pre></div></div>

<p>Repositorios de python-tripleoclient:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo curl -o /etc/yum.repos.d/delorean-liberty.repo https://trunk.rdoproject.org/centos7-liberty/current/delorean.repo
sudo curl -o /etc/yum.repos.d/delorean-deps-liberty.repo http://trunk.rdoproject.org/centos7-liberty/delorean-deps.repo
</code></pre></div></div>

<p>Instalamos Python TripleO:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum install -y python-tripleoclient
</code></pre></div></div>

<p>Copiamos la configuración de ejemplo de undercloud:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp /usr/share/instack-undercloud/undercloud.conf.sample ~/undercloud.conf
</code></pre></div></div>

<p>Editamos la configuración:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano undercloud.conf
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[DEFAULT]
local_ip = 192.168.0.10/24
undercloud_public_vip = 192.168.0.11
undercloud_admin_vip = 192.168.0.12
local_interface = ens8
masquerade_network = 192.168.0.0/24
dhcp_start = 192.168.0.60
dhcp_end = 192.168.0.80
network_cidr = 192.168.0.0/24
network_gateway = 192.168.0.1
discovery_iprange = 192.168.0.60,192.168.0.80
[auth]
</code></pre></div></div>

<p>Nos aseguramos de añadir un buen DNS:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo nameserver 8.8.8.8 &gt;&gt; /etc/resolv.conf
</code></pre></div></div>

<p>Instalamos undercloud:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack undercloud install
</code></pre></div></div>

<p>Este bug, que reporte al launchpad esta actualmente solucionado.</p>

<p><strong>ERROR:</strong> https://bugs.launchpad.net/tripleo/+bug/1544150</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1710 packages excluded due to repository priority protections
Traceback (most recent call last):
    File "&lt;string&gt;", line 1, in &lt;module&gt;
    File "/usr/lib/python2.7/site-packages/instack_undercloud/undercloud.py", line 750, in install
        _run_instack(instack_env)
    File "/usr/lib/python2.7/site-packages/instack_undercloud/undercloud.py", line 636, in _run_instack
        _run_live_command(args, instack_env, 'instack')
    File "/usr/lib/python2.7/site-packages/instack_undercloud/undercloud.py", line 341, in _run_live_command
        line = process.stdout.readline().decode()
UnicodeDecodeError: 'ascii' codec can't decode byte 0xc3 in position 74: ordinal not in range(128)
</code></pre></div></div>

<p><strong>SOLUCION:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano /usr/lib/python2.7/site-packages/instack_undercloud/undercloud.py
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>line = process.stdout.readline().decode('utf-8')
</code></pre></div></div>

<p>Finalizado del comando</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------- END PROFILING ---------------------
[2016-03-14 14:15:35,119] (os-refresh-config) [INFO] Completed phase post-configure
os-refresh-config completed successfully
Generated new ssh key in ~/.ssh/id_rsa
Created flavor "baremetal" with profile "None"
Created flavor "control" with profile "control"
Created flavor "compute" with profile "compute"
Created flavor "ceph-storage" with profile "ceph-storage"
Created flavor "block-storage" with profile "block-storage"
Created flavor "swift-storage" with profile "swift-storage"

#############################################################################
Undercloud install complete.

The file containing this installation's passwords is at
/home/stack/undercloud-passwords.conf.

There is also a stackrc file at /home/stack/stackrc.

These files are needed to interact with the OpenStack services, and should be
secured.

#############################################################################
</code></pre></div></div>

<p><strong>ERROR LOOP al apagar:</strong> https://bugzilla.redhat.com/show_bug.cgi?id=1178497</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm: cannot remove /lib/drauct/hooks/shutdown/30-dm-shutdown.sh: Read-only filesystem
</code></pre></div></div>

<p><strong>SOLUCIÓN:</strong></p>

<p>Reinstalamos Dracut:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum reinstall dracut
</code></pre></div></div>

<p>Editamos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /usr/lib/dracut/modules.d/99shutdown/shutdown.sh
</code></pre></div></div>

<p>Despues de:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. /lib/dracut-lib.sh
</code></pre></div></div>

<p>Añadir:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if [ "$(stat -c '%T' -f /)" = "tmpfs" ]; then
        mount -o remount,rw /
fi
</code></pre></div></div>

<p>Editamos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /usr/lib/dracut/modules.d/99shutdown/module-setup.sh
</code></pre></div></div>

<p>Buscar:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inst_multiple umount poweroff reboot halt losetup
</code></pre></div></div>

<p>Cambiar por:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inst_multiple umount poweroff reboot halt losetup stat
</code></pre></div></div>

<p>Recrear initramfs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo dracut --force
</code></pre></div></div>

<p>unmask shutdown:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl unmask dracut-shutdown.service
</code></pre></div></div>

<p>Reinciamos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo reboot
</code></pre></div></div>

<p>Activamos stackrc con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source /home/stack/stackrc
</code></pre></div></div>

<p>Creación de imagenes para el opvercloud:</p>

<ul>
  <li>
    <p><strong>Opcion 1:</strong></p>

    <p>Creamos las imagenes, puede tardar mucho tiempo:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  openstack overcloud image build --all
</code></pre></div>    </div>

    <p><strong>ERROR</strong></p>
    <pre class="highlight">
  Required file "ironic-python-agent.initramfs" does not exist.
  </pre>

    <p><strong>SOLUCIÓN</strong></p>

    <p>La intuición me dice que los dos ficheros son el mismo (Comparando .kernel de fedora)
      &lt;pre class="highlight"&gt;
      [stack@undercloud images2]$ ls -hl <em>kernel</em>
      -rw-r–r–. 1 stack stack 5,0M mar 16 08:24 deploy-ramdisk-ironic.kernel
      -rw-r–r–. 1 stack stack 5,0M mar 16 08:25 ironic-python-agent.kernel
      [stack@undercloud images2]$ diff <em>kernel</em>
      cp deploy-ramdisk-ironic.initramfs ironic-python-agent.initramfs
      cp deploy-ramdisk-ironic.kernel ironic-python-agent.kernel
      &lt;/pre&gt;</p>
  </li>
  <li>
    <p><strong>Opcion 2:</strong></p>

    <p>Bajar las imagenes de fedora:</p>
    <pre class="highlight">
  wget -r -nd -np --reject "index.html\*" https://repos.fedorapeople.org/repos/openstack-m/rdo-images-centos-liberty-opnfv/
  </pre>
  </li>
</ul>

<p>Subimos las imagenes al undercloud con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack overcloud image upload --image-path /home/stack/images
</code></pre></div></div>

<p><strong>BONUS</strong> - borrar imagenes de glance:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(glance image-list | grep -v ID | awk ' { print $2 } '); do glance image-delete $i; done
</code></pre></div></div>

<p>Podremos ver las imagenes cargadas con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[stack@undercloud images]$ openstack image list
+--------------------------------------+------------------------+
| ID                                                                     | Name                                     |
+--------------------------------------+------------------------+
| f872cf08-afd7-4d86-a008-465730c3ecb2 | bm-deploy-kernel             |
| b3215dfe-8548-42b0-80aa-2ccae02574ac | bm-deploy-ramdisk            |
| 583c3a7f-bce3-47db-ba0d-0750e601684f | overcloud-full                 |
| 1f2166b1-e8bc-4351-b5db-8ebcad37b9f2 | overcloud-full-initrd    |
| f327bae7-3d53-4a78-be14-2139457d04ad | overcloud-full-vmlinuz |
+--------------------------------------+------------------------+
</code></pre></div></div>

<p>Podremos ver las subredes con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[stack@undercloud images]$ neutron subnet-list
+--------------------------------------+------+----------------+--------------------------------------------------+
| id                                                                     | name | cidr                     | allocation_pools                                                                 |
+--------------------------------------+------+----------------+--------------------------------------------------+
| 791d86a8-e607-4f67-9c85-b5228f599910 |            | 192.168.0.0/24 | {"start": "192.168.0.60", "end": "192.168.0.80"} |
+--------------------------------------+------+----------------+--------------------------------------------------+
</code></pre></div></div>

<p>Actualizamos la red con el dns:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neutron subnet-update 791d86a8-e607-4f67-9c85-b5228f599910 --dns-nameserver 192.168.0.81
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[stack@undercloud ~]$ neutron subnet-show 791d86a8-e607-4f67-9c85-b5228f599910
+-------------------+------------------------------------------------------------------+
| Field                         | Value                                                                                                                        |
+-------------------+------------------------------------------------------------------+
| allocation_pools    | {"start": "192.168.0.60", "end": "192.168.0.80"}                                 |
| cidr                            | 192.168.0.0/24                                                                                                     |
| dns_nameservers     | 8.8.4.4                                                                                                                    |
| enable_dhcp             | True                                                                                                                         |
| gateway_ip                | 192.168.0.1                                                                                                            |
| host_routes             | {"destination": "169.254.169.254/32", "nexthop": "192.168.0.81"} |
| id                                | 791d86a8-e607-4f67-9c85-b5228f599910                                                         |
| ip_version                | 4                                                                                                                                |
| ipv6_address_mode |                                                                                                                                    |
| ipv6_ra_mode            |                                                                                                                                    |
| name                            |                                                                                                                                    |
| network_id                | 67917664-1468-4658-bba4-90574e1bd997                                                         |
| subnetpool_id         |                                                                                                                                    |
| tenant_id                 | 7b4c8e02a48849aaa8a0d06bb44a4f8c                                                                 |
+-------------------+------------------------------------------------------------------+
</code></pre></div></div>

<p>En mi caso a los clientes no les asigna el DNS, podemos introducirlo manualmente:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo server=8.8.8.8 &gt;&gt; /etc/ironic-inspector/dnsmasq.conf
</code></pre></div></div>

<p><strong>BONUS</strong> - Eliminar las maquinas</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in {1..2}; do virsh destroy overcloud-node$i; virsh undefine overcloud-node$i; done
</code></pre></div></div>

<p>Configuramos el acceso:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo cat &lt;&lt; EOF &gt; /etc/polkit-1/localauthority/50-local.d/50-libvirt-user-stack.pkla
[libvirt Management Access]
Identity=unix-user:centos
Action=org.libvirt.unix.manage
ResultAny=yes
ResultInactive=yes
ResultActive=yes
</code></pre></div></div>

<p>Añadimso la clave publica para la conexión ssh:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano .ssh/authorized_keys
</code></pre></div></div>

<h2 id="anfitrion-undercloud">Anfitrion Undercloud</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF &gt; /usr/bin/bootif-fix
#!/usr/bin/env bash

while true;
                do find /httpboot/ -type f ! -iname "kernel" ! -iname "ramdisk" ! -iname "*.kernel" ! -iname "*.ramdisk" -exec sed -i 's|{mac|{net0/mac|g' {} +;
done
EOF
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod a+x /usr/bin/bootif-fix
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF &gt; /usr/lib/systemd/system/bootif-fix.service
[Unit]
Description=Automated fix for incorrect iPXE BOOFIF

[Service]
Type=simple
ExecStart=/usr/bin/bootif-fix

[Install]
WantedBy=multi-user.target
EOF 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod a+x /usr/lib/systemd/system/bootif-fix.service
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable bootif-fix
systemctl start bootif-fix
</code></pre></div></div>

<h2 id="overcloud">Overcloud</h2>

<p>Mapeamos las maquinas con el nombre overcloud-node* y optenemos la MAC que tienen en el puente aprovisionamient:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in {1..2}; do virsh -c qemu+ssh://xerrot@192.168.0.82/system domiflist overcloud-node$i | awk '$3 == "interno" {print $5};'; done &gt; /home/stack/nodes.txt
</code></pre></div></div>

<p>BONUS - Borrar todos los nodos de ironic:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(ironic node-list | grep -v UUID | awk ' { print $2 } '); do ironic node-delete $i; done
</code></pre></div></div>

<p>BONUS - Apagar los nodos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(ironic node-list | grep -v UUID | awk ' { print $2 } '); do ironic node-set-power-state $i off; done
</code></pre></div></div>

<p>Introducir nodos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jq . &lt;&lt; EOF &gt; /home/stack/instackenv.json
{
    "ssh-user": "xerrot",
    "ssh-key": "$(cat cat /home/stack/.claves/id_rsa)",
    "power_manager": "nova.virt.baremetal.virtual_power_driver.VirtualPowerManager",
    "host-ip": "192.168.0.81",
    "arch": "x86_64",
    "nodes": [
        {
            "pm_addr": "192.168.0.82",
            "pm_password": "$(cat /home/stack/.claves/id_rsa)",
            "pm_type": "pxe_ssh",
            "mac": [
                "$(sed -n 1p /home/stack/nodes.txt)"
            ],
            "cpu": "4",
            "memory": "4096",
            "disk": "45",
            "arch": "x86_64",
            "pm_user": "xerrot"
        },
        {
            "pm_addr": "192.168.0.82",
            "pm_password": "$(cat /home/stack/.claves/id_rsa)",
            "pm_type": "pxe_ssh",
            "mac": [
                "$(sed -n 2p /home/stack/nodes.txt)"
            ],
            "cpu": "4",
            "memory": "4096",
            "disk": "45",
            "arch": "x86_64",
            "pm_user": "xerrot"
        }
    ]
}
EOF
</code></pre></div></div>

<p>Importamos la configuración anterior:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack baremetal import --json instackenv.json
</code></pre></div></div>

<p>Podremos listar los nodos con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ironic node-list
</code></pre></div></div>

<p>Configuramos el boot:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack baremetal configure boot
</code></pre></div></div>

<p>Realizamos una introspection:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack baremetal introspection bulk start
</code></pre></div></div>

<p><strong>ERROR</strong> en maquina virtual http://ipxe.org/040ee119</p>

<p><strong>SOLUCION:</strong></p>

<p>Reducimos el tiempo de espera:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo brctl setfd br1 2
</code></pre></div></div>

<p>Consultar log con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo journalctl -fu openstack-ironic-inspector-dnsmasq -fu openstack-ironic-inspector 
</code></pre></div></div>

<p>Consultar puertos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo tcpdump -i any port 67 or port 68 or port 69 or port 80 or port 8088
</code></pre></div></div>

<p><strong>ERROR</strong> http://ipxe.org/2e008001 o errores en el arranque de las maquinas:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>agent.kernel y agent.ramdisk en blanco o dañados.
</code></pre></div></div>

<p><strong>SOLUCION:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /httpboot
sudo cp -f ironic-python-agent.kernel /httpboot/agent.kernel
sudo cp -f ironic-python-agent.initramfs /httpboot/agent.ramdisk
</code></pre></div></div>

<p>Asignamos rol:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ironic node-list

ironic node-update a04bddb8-2dc3-4627-8c0b-82a02a574a86 replace properties/capabilities=profile:control,boot_option:local
ironic node-update 26fc0ce0-d6dd-42ae-81c7-e9e0e3d5dcb5 replace properties/capabilities=profile:compute,boot_option:local
</code></pre></div></div>

<p>Validamos con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack overcloud deploy --templates --control-scale 1 --compute-scale 1 --neutron-tunnel-types vxlan --neutron-network-type vxlan \
    --validation-errors-fatal --validation-warnings-fatal --dry-run 

openstack baremetal configure ready state
openstack baremetal instackenv validate
</code></pre></div></div>

<p>Desplegamos overcloud ejecutando:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack overcloud deploy --templates --control-scale 1 --compute-scale 1
</code></pre></div></div>

            </div>
            
                
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
                
            
            </div>
          </div>
          <div class="pagination">
              
                <a class="btn btn-default" href="/2016/08/Pantalla-LCD-16x2-y-PCF8574-(I2C)-para-Raspberry-pi" class="next">Newer Post</a>
              
              
                <a class="btn btn-default" href="/2016/07/Control-de-retroiluminacion-en-teclado-CMSTORM" class="previous">Older Post</a>
              
          </div>
        </div>
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
    <!--<h4>Twitter</h4>
    <a class="twitter-timeline" data-height="515" href="https://twitter.com/Zerrotajo?ref_src=twsrc%5Etfw">Tweets by Zerrotajo</a>
    <a href="https://twitter.com/intent/tweet?button_hashtag=sysadmin&ref_src=twsrc%5Etfw" class="twitter-hashtag-button" data-show-count="false">#sysadmin</a>
    <a href="https://twitter.com/intent/tweet?button_hashtag=kubernetes&ref_src=twsrc%5Etfw" class="twitter-hashtag-button" data-show-count="false">#kubernetes</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>-->
<h4>Kubernetes Containers Tools</h4>
  <ul>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/squirrel">Squirel secrets rotation</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/liberty">Liberty Ingress</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/secure_emailing">Secure Emailing Gateway</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/cloud-cementery/docker">Cloud Cementery</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/cron-backup-kubernetes">Backups for Kubernetes in yaml</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/backup-db-cron">Backups/Snapshots for all</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/sftp-multiuser">SFTP Multiuser</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/statefulset_autoscaler">StatefulSet autoscaler</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/tools/Kubernetes/concurrent-kubectl-gcloud">Concurrent kubectl gcloud</a></li>
    <li><a href="https://github.com/Tedezed/kubernetes-containers-tools/tree/master/debian-box">Debian Box</a></li>
  </ul>
</div>


        </div>
    </div>
</div>


  <script type="text/javascript">
    var disqus_shortname = 'www-aventurabinaria-es';

    var disqus_config = function () {
        this.page.identifier = '2016-08-openstack-tripleo-instalacion';
    };

   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


<!--<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">&copy;2022 Aventura Binaria. Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a>
            under
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a></p>
        </div>
    </div>
</div>-->


  <script type="text/javascript">
    var disqus_shortname = 'www-aventurabinaria-es';

    var disqus_config = function () {
        this.page.identifier = '2016-08-openstack-tripleo-instalacion';
    };

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>


<!--
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-153422845-1"></script>
  <script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-153422845-1');
  </script>

-->

</body>
</html>

